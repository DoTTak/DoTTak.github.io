---
layout: post
title: "[리버스엔지니어링-이론] 01 - PE 구조"
date: 2020-05-13 22:17:50 +0900
categories: 
    - 리버스엔지니어링
tags:
    - 리버스엔지니어링
    - PE
toc: true
notice: "> 본 글은 [이호동 저 '윈도우 실행 파일 구조와 원리로 배우는 리버스 엔지니어링 1권 - 파일 구조 편'](http://www.yes24.com/Product/Goods/32452768?Acode=101)을 보고 공부하면서 정리한 내용입니다."

---

<!-- more -->

## 01. PE File Format
- PE란?
    - PE는 `Portable Executable`의 약자
    - MS에서 EXE와 DLL이 갖는 파일 구조를 PE 파일 포맷이라고 명명함
        - EXE, DLL 파일모두 헥사 에디터를 통해 열게 되면 'MZ'로 시작한다. 그리고 이러한 구조를 'PE' 구조라고 함
    - Windows OS의 서브 시스템으로 존재하는 `프로그램 로더(Loader)`로 EXE파일을 로드하고 EXE의 파일 구조는 이 로더가 식별할 수 있는 방식으로 구성
        - 이때, EXE의 파일구조는 'MZ'로 시작하는 PE 구조
    - 즉, PE 포맷으로 구성된 파일들은 플랫폼에 관계 없이 Windows OS가 돌아가는 시스템이면 어디서든(Portable) 실행 가능(Executable)하다.

- PE에서의 이미지(Image)라는 단어
    - PE파일은 하드디스크에 파일로 존재하지만, 실행하기 위해 메모리로 로드될 때에는 일반 데이터 파일이 메모리에 로드되는 방식과 전혀 다른 방식으로 로드된다.
    - 한 프로세스에 할당되는 32비트 또는 64비트의 가상 주소 공간을 유지하기 위해 `가상 메모리 관리자(Virtual Memory Manager, VMM)`는 페이지 파일이라는 스와핑(Swapping) 영역을 하드디스크에 유지하며, 이 페이지 파일과의 스와핑, 매핑을 통해 프로세스에게 마치 32비트 또는 64비트의 가상 공간을 실제로 제공해주는 것처럼 프로세스를 속이고 있는 것
    - PE파일이 로드될 때 VMM은 페이지 파일을 사용하지 않고 PE 파일 자체를 마치 페이지 파일처럼 가상 주소 공간에 그대로 매핑
        - 윈도우 프로그래머들이 프로세스 간 통신을 위해 애용하는 공유 메모리 메커니즘을 통해 PE 파일 자체를 직접 가상 주소 공간에 매핑해버리는 것
            - '공유 메모리'라고 알려진 IPC 방식은 실제 메모리에 매핑된 파일이며, PE 파일을 효율적으로 메모리에 로드하기 위해 MS가 고안해낸 방식을 그 범위를 넓혀 IPC에도 이용할 수 있도록 다른 사용 용도를 제안한 것일 수 도 있다.
    - 즉, 어떤 실체에 대한 그림자, 허상, 그것의 반영이라는 의미에서 이미지라 부름
        - 이미지라는 것은 바로 메모리에 매핑된 하드디스크의 PE 파일의 이미지인 것
            - 하드디스크에는 PE 파일이, 그것의 반영이 가상 주소 공간에 로드된 PE
            - 메모리에 로드된 PE포맷이나 디스크 상에 파일로 존재하는 PE포맷이나 거의 같다.
    - **PE파일 포맷 분석을 통해 '공유 메모리'의 메커니즘을 알 수 있고, VMM이 윈도우 가상 주소 공간을 관리하는 방식을 제대로 공부해야 PE와 메모리의 관계를 제대로 이해할 수 있다.**

- PE+ 란?
    - 32비트 PE와의 호환성을 최대한 염두에 두었으며, PE+는 32비트 PE와 크게 차이가 없고, 32비트 PE를 그대로 수용하면서 기존 PE 포맷에 새로운 요소를 추가한 것
        - 새로운 요소로 대표적인 것이 32비트 PE에 없었던 '예외 섹션'

## 02. PE 파일 구조
- PE 파일 포맷은 'COFF(Common Object File Format)'라는 포맷을 계승한 파일 포맷
    - COFF 포맷은 MS에서 사용하던 이전 버전의 여러 실행 파일 뿐만 아니라 Library, OBJ 파일에 대한 공통 포맷을 제공
- `IMAGE_XXX_XXXX` 형태의 명칭들은 모두 `WinNT.h` 헤더 파일에 정의된 구조체
- PE 파일 포맷은 MZ로 시작하는 `IMAGE_DOS_HEADER` 구조체를 시작으로 도스와의 호환을 위한 코드인 도스 스텁을 담고 있다. 이 스텁 다음부터 실제 PE 포맷이 시작된다.
    - 실질적인 PE 포맷의 시작은 `IMAGE_NT_HEADERS` 라는 구조체로 정의된 헤더로 표현된다.
        - PE 파일의 헤더
            - `IMAGE_NT_HEADRS`는 'PE' 시그니처를 시작으로 차례대로 `IMAGE_FILE_HEADER`, `IMAGE_OPTIONAL_HEADER` 구조체로 구성 된다.
                - `IMAGE_FILE_HEADER`
                    - PE 파일의 파일 정보를 담음
                - `IMAGE_OPTIONAL_HEADER`
                    - 전혀 선택적이지 않은 PE 파일이 메모리에 로드될 때 필요한 중요한 정보를 담음
                    - 기본 필드들과 함께 주요 섹션과 정보의 위치 및 크기를 나타내는 `IMAGE_DATA_DIRECTORY` 구조체의 배열이 존재
            - `IMAGE_OPTIONAL_HEADER` 구조체에 이어 섹션 헤더라 불리는 `IMAGE_SECTION_HEADER` 구조체의 배열이 펼쳐진다.
        - 
- PE 파일의 헤더 이후부터는 실제 내용들 즉, 코드나 데이터들이 섹션(Section)이라는 블록 단위로 각각 저장 된다.
    - `IMAGE_SECTION_HEADER` 구조체
        - 이 섹션의 시작 위치와 크기, 그리고 속성을 담고 있는 헤더
        - 이 구조체의 배열이 '섹션 헤더 테이블'
        - 섹션 헤더가 가리키는 각각의 섹션은 그 종류에 따라 자체 포맷을 갖는다.
            - .text 섹션
                - 실행코드를 담고 있음
            - .data 섹션
                - 전역 데이터를 담고 있음
            - .idata, .edata 섹션
                - 가져오기 함수/변수와 내보내기 함수 또는 변수에 대한 저보를 담고 있음
            - .rsrc 섹션
                - 대화상자나 아이콘, 메뉴 등의 리소스 데이터의 내용을 담고 있음
